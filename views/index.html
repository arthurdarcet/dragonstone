{% extends "layout.html" %}

{% block title %}{{ name }}{% endblock %}

{% block content %}
<div class="page-header">
	<h1>{{ name }} <small class="pull-right">Base URL: <a href="{{ base_url }}">{{ base_url }}</a></small></h1>
</div>
<ul id="tabs" class="nav nav-tabs" data-tabs="tabs">
	{% for endpoint in endpoints %}
	<li class="{% if loop.first %}active{% endif %}"><a href="#{{ endpoint.name }}" data-toggle="tab">{{ endpoint.name}}</a></li>
	{% endfor %}
	<li class="pull-right"><a id="go-to-custom-types" href="#custom-types" data-toggle="tab">Custom types</a></li>
</ul>
<div class="tab-content">
	{% for endpoint in endpoints %}
	<div class="tab-pane {% if loop.first %}active{% endif %}" id="{{ endpoint.name }}">
		{% for method in endpoint.methods %}
		<div class="panel panel-default">
			<div class="panel-heading">
				{% if method.auth_required %}
				<i class="glyphicon glyphicon-lock"></i>
				{% endif %}
				<span class="btn btn-default btn-sm pull-right test-endpoint">Try it</span>
				<span class="verb">{{ method.verb }}</span>
				<span class="uri">{{ endpoint.prefix}}{{ method.URI }}</span>{% if method.description %}:{% endif %} 
				<span class="text-muted">{{ method.description }}</span>
			</div>
			<dl class="list-group">
				{% if method.parameters %}
				<dt class="list-group-item">Parameters:</dt>
				<dd class="list-group-item">
					<table class="table">
						<thead>
							<tr>
								<th></th>
								<th>Key</th>
								<th>Value</th>
								<th>Type</th>
								<th>Description</th>
							</tr>
						</thead>
						<tbody>
							{% for parameter in method.parameters %}
							<tr>
								<td>{% if parameter.required %}*{% endif %}</td>
								<td>{{ parameter.name }}</td>
								<td>{{ parameter|value|raw }}</td>
								<td>{{ parameter|type|raw }}</td>
								<td>{{ parameter.description }}</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</dd>
				{% endif %}
				<dt class="list-group-item">Response code:</dt>
				<dd class="list-group-item">
					{% if method.response_code.toFixed %}
					{# The response code is an int #}
					<span class="response-code">{{ method.response_code }}</span>
					{% else %}
					{% for description in method.response_code %}
					<span class="response-code">{{ loop.key }}</span>: {{ description }}<br>
					{% endfor %}
					{% endif %}
				</dd>
				<dt class="list-group-item">Response:</dt>
				<dd class="list-group-item">
					<div class="object">
						{{ method.response|object|raw }}
					</div>
				</dd>
				<dt class="list-group-item hide test-result">Results:</dt>
				<dd class="list-group-item hide test-result">
					<div class="object test-result-data"></div>
					<div class="test-result-error alert alert-danger"></div>
					<div class="test-result-loading"></div>
				<dd>
			</dl>
		</div>
		{% endfor %}
	</div>
	{% endfor %}
	<div class="tab-pane" id="custom-types">
		{% for type in custom_types %}
		{% if not type.inline %}
		<div id="custom-type-{{ loop.key }}" class="panel panel-default">
			<div class="panel-heading">{{ type.name }}</div>
			<div class="panel-body">{{ type.type|object|raw }}</div>
		</div>
		{% endif %}
		{% endfor %}
	</div>
</dl>

{% endblock %}

{% block js %}
{% parent %}
<script>
	$(document).ready(function() {
		$('.custom-type').click(function(evt) {
			$('#go-to-custom-types').click();
		});
		$('.test-endpoint').click(function(evt) {
			var endpoint = $(evt.currentTarget).parent().parent();
			var data_el = endpoint.find('.test-result-data').hide();
			var error_el = endpoint.find('.test-result-error').hide();
			var loading_el = endpoint.find('.test-result-loading').show();
			endpoint.find('.test-result').removeClass('hide');

			var params = {};
			endpoint.find('input').each(function() {
				if (this.value) params[this.name] = this.value;
			});
			$.ajax({
				url: '/call',
				data: {
					url: endpoint.find('.uri').html(),
					params: params,
					method: endpoint.find('.verb').html()
				}
			}).always(function(data, status, error) {
				loading_el.hide();
				if (status == 'success') {
					data_el.show();
					data_el.html(data);
				}
				else {
					error_el.show();
					error_el.html((error || 'Error') + ': ' + data.responseText);
				}
			});
		})
	});
</script>
{% endblock %}
